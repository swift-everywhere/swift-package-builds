name: Build Major Packages
on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'
  push:
    branches: [main]
    paths:
      - '.github/workflows/buildmajor.yml'

jobs:
  build-major-packages:
    strategy: 
      fail-fast: false
      matrix:
        swift: ['6.0', '6.1']
        os: ['macos-latest', 'ubuntu-latest']
    runs-on: ${{ matrix.os }}
    steps:
      - name: Setup Android Toolchain
        id: setup-toolchain-android
        uses: skiptools/swift-android-action@main
        with:
          # just set up the toolchain and don't build anything
          build-package: false
          swift-version: ${{ matrix.swift }}

      - name: Checkout swift-algorithms
        uses: actions/checkout@v4
        with:
          repository: apple/swift-algorithms
          path: swift-algorithms
      - name: Build swift-algorithms
        shell: bash
        working-directory: swift-algorithms
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout swift-format
        uses: actions/checkout@v4
        with:
          repository: apple/swift-format
          path: swift-format
      - name: Build swift-format
        shell: bash
        working-directory: swift-format
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout swift-markdown
        uses: actions/checkout@v4
        with:
          repository: apple/swift-markdown
          path: swift-markdown
      - name: Build swift-markdown
        shell: bash
        working-directory: swift-markdown
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout swift-syntax
        uses: actions/checkout@v4
        with:
          repository: apple/swift-syntax
          path: swift-syntax
      - name: Build swift-syntax
        shell: bash
        working-directory: swift-syntax
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout swift-testing
        uses: actions/checkout@v4
        with:
          repository: apple/swift-testing
          path: swift-testing
      - name: Build swift-testing
        if: false # TODO: identify problems
        shell: bash
        working-directory: swift-testing
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout swift-tools-support-core
        uses: actions/checkout@v4
        with:
          repository: swiftlang/swift-tools-support-core
          path: swift-tools-support-core
      - name: Build swift-tools-support-core
        shell: bash
        working-directory: swift-tools-support-core
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }}
          #--build-tests # fails without --android-spawn

      - name: Checkout swift-package-manager
        uses: actions/checkout@v4
        with:
          repository: apple/swift-package-manager
          path: swift-package-manager
      - name: Build swift-package-manager
        shell: bash
        working-directory: swift-package-manager
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout swift-certificates
        uses: actions/checkout@v4
        with:
          repository: apple/swift-certificates
          path: swift-certificates
      - name: Build swift-certificates
        shell: bash
        working-directory: swift-certificates
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout swift-toolchain-sqlite
        uses: actions/checkout@v4
        with:
          repository: swiftlang/swift-toolchain-sqlite
          path: swift-toolchain-sqlite
      - name: Build swift-toolchain-sqlite
        shell: bash
        working-directory: swift-toolchain-sqlite
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout swift-java
        uses: actions/checkout@v4
        with:
          repository: swiftlang/swift-java
          path: swift-java
      - name: Build swift-java
        if: false # TODO: diagnose
        # no Testing in Swift Android SDK for 6.0
        #if: ${{ matrix.swift != '6.0' }}
        shell: bash
        working-directory: swift-java
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout swift-crypto
        uses: actions/checkout@v4
        with:
          repository: apple/swift-crypto
          path: swift-crypto
      - name: Build swift-crypto
        shell: bash
        working-directory: swift-crypto
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout swift-numerics
        uses: actions/checkout@v4
        with:
          repository: apple/swift-numerics
          path: swift-numerics
      - name: Build swift-numerics
        shell: bash
        working-directory: swift-numerics
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout swift-system
        uses: actions/checkout@v4
        with:
          repository: apple/swift-system
          path: swift-system
      - name: Build swift-system
        shell: bash
        if: false # needs https://github.com/apple/swift-system/pull/225
        working-directory: swift-system
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout swift-collections
        uses: actions/checkout@v4
        with:
          repository: apple/swift-collections
          path: swift-collections
      - name: Build swift-collections
        shell: bash
        working-directory: swift-collections
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout swift-atomics
        uses: actions/checkout@v4
        with:
          repository: apple/swift-atomics
          path: swift-atomics
      - name: Build swift-atomics
        shell: bash
        working-directory: swift-atomics
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout swift-foundation
        uses: actions/checkout@v4
        with:
          repository: apple/swift-foundation
          path: swift-foundation
      - name: Build swift-foundation
        shell: bash
        working-directory: swift-foundation
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }}
          # tests not working yet
          # --build-tests

      - name: Checkout swift-nio
        uses: actions/checkout@v4
        with:
          repository: apple/swift-nio
          path: swift-nio
      - name: Build swift-nio
        shell: bash
        working-directory: swift-nio
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout swift-nio-http2
        uses: actions/checkout@v4
        with:
          repository: apple/swift-nio-http2
          path: swift-nio-http2
      - name: Build swift-nio-http2
        shell: bash
        working-directory: swift-nio-http2
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout swift-nio-ssl
        uses: actions/checkout@v4
        with:
          repository: apple/swift-nio-ssl
          path: swift-nio-ssl
      - name: Build swift-nio-ssl
        if: false # error: cannot find 'open' in scope
        shell: bash
        working-directory: swift-nio-ssl
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout jpsim/Yams
        uses: actions/checkout@v4
        with:
          repository: jpsim/Yams
          path: Yams
      - name: Build jpsim/Yams
        shell: bash
        working-directory: Yams
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout tayloraswift/swift-png
        uses: actions/checkout@v4
        with:
          repository: tayloraswift/swift-png
          path: swift-png
      - name: Build tayloraswift/swift-png
        # no Testing in Swift Android SDK for 6.0
        if: ${{ matrix.swift != '6.0' }}
        shell: bash
        working-directory: swift-png
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout vapor/vapor
        uses: actions/checkout@v4
        with:
          repository: vapor/vapor
          path: vapor
      - name: Build vapor/vapor
        if: false # TODO
        shell: bash
        working-directory: vapor
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests

      - name: Checkout grpc/grpc-swift
        uses: actions/checkout@v4
        with:
          repository: grpc/grpc-swift
          path: grpc-swift
      - name: Build grpc/grpc-swift
        # no Testing in Swift Android SDK for 6.0
        if: ${{ matrix.swift != '6.0' }}
        shell: bash
        working-directory: grpc-swift
        run: |
          ${{ steps.setup-toolchain-android.outputs.swift-build }} --build-tests
